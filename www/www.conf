#
# Production NGINX server
#
# This NGINX configuration serves as a simple reverse-proxy to unify all
# services into one convenient endpoint so that the developer doesn't
# have to remember so many ports.
#
# The main application will be available via:
#   /       Client application
#   /portal Clinician portal
#   /api    API service

server {

  listen 80 default_server;
	listen [::]:80 default_server;

  # Use whatever server name is assigned to this machine
	server_name _;

  # Switch to JSON logging for ELK stack (see nginx.conf)
  access_log /var/log/nginx/access.log json;

  # Path for mounting auto-generated content
  root /var/www/public;

  # Allow large request payloads.
  client_max_body_size 10m;

  # Set globally
  proxy_set_header HOST $host;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_pass_request_headers on;

  # Use custom error pages instead of proxy error pages
  proxy_intercept_errors on;

  # This is required to allow usage of pre-built gziped files on proxied servers
  proxy_http_version 1.1;

  # error_page 404 /404.html;
  #   location = /404.html {
  # }

  # error_page 500 502 503 504 /50x.html;
  #   location = /50x.html {
  # }

  # location /api/ {
  #   proxy_pass http://api:4000/;
  # }

  # location /media/ {
  #   proxy_pass http://api:4000/media/;
  # }

  # location /auth/ {
  #   proxy_pass http://auth:8000/;
  # }

  # location /syslog/ {
  #   # Update kibana server.basePath to reflect proxy path
  #   proxy_pass http://kibana:5601/;
  #   auth_basic "Restricted";
  #   auth_basic_user_file /etc/nginx/conf.d/kibana.htpasswd;
  # }

  # Auto-generated Django assets
  # location /static/ { }

  # Bundled 3rd party portal assets
  # location /portal/public/ { }

  # location /portal/ {
  #   proxy_pass http://portal:8080/;
  # }

  # location / {
  #   proxy_pass http://client:8080/;
  # }

  # # Serve protected static content
  # location /protected/ {
  #   internal;
  #   alias /opt/filestorage/;
  # }

}
